# 7.3 Create vector search

**核心目標：解決有了嵌入向量之後，如何建立索引並快速、有效地在龐大的向量空間中進行搜尋。**

**主要挑戰：**

1. **如何測量向量間的距離/相似度？**
2. **如何快速且可規模化地搜尋向量？**

**挑戰一：測量向量距離**

- **背景**：在高維度的向量空間中，需要量化指標來判斷向量間的相似程度（例如，「巴黎」和「東京」是否比「巴黎」和「蘋果」更近）。
- **選擇依據**：選擇哪種距離度量方式，通常與生成這些嵌入向量的模型有關。
- **四種常用指標**：
    1. **曼哈頓距離 (Manhattan Distance / L1)**：計算各維度座標差的絕對值總和（想像在棋盤格狀的城市街道上走，只能轉彎不能斜線走）。
    2. **歐氏距離 (Euclidean Distance / L2)**：計算兩點間直線的最短距離（我們最熟悉的距離公式）。
    3. **餘弦距離/相似度 (Cosine Distance/Similarity)**：測量兩個向量之間的**角度**，判斷它們的**方向相似度**（數值 0 代表方向完全一致，1 代表完全正交 - _請注意，這裡描述的數值可能與常見的餘弦相似度定義略有不同，但核心是看角度_）。
    4. **點積距離 (Dot Product Distance)**：同時測量兩個向量在**方向和大小（幅度）** 上的相似度（一個向量在另一個向量上的投影長度）。

**挑戰二：高效搜尋向量**

- **背景**：當向量數量達到數百萬甚至數十億時，逐一比較非常耗時。
- **方法一：暴力演算法 (Brute-Force)**
    - **作法**：計算查詢向量與資料庫中**每一個**向量的距離 -> 排序所有距離 -> 找出距離最近的前 K 個。
    - **優點**：結果**精確**、**詳盡**。
    - **缺點**：計算量巨大 (複雜度 O(N*d)，N 是向量數，d 是維度)，對於大數據集來說**不切實際**，會成為效能瓶頸。
- **方法二：近似最鄰近搜尋 (Approximate Nearest Neighbor, ANN)**
    - **核心思想**：犧牲一點點**準確率**，換取搜尋**速度和可擴展性**的大幅提升。找到的是「近似」或「大概」最接近的鄰居。
    - **技術範例**：TreeAh（淺層樹與不對稱雜湊）是一種常用於生產環境的 ANN 算法。
    - **Google 的先進算法：ScaNN (Scalable Nearest Neighbors)**
        - 2020 年由 Google Research 推出，被廣泛應用於 Google 搜尋、YouTube 推薦等服務。
        - 被認為是業界在速度和準確率方面**表現最佳**的 ANN 算法之一。

**ScaNN 如何實現快速、可擴展的向量搜尋？(結合多種技術)**

1. **縮減搜尋空間 (空間修剪 / Spatial Pruning)**：
    - **作法**：將整個向量空間劃分成**階層式的分區**（像大區包含小區），並建立一棵**搜尋樹**來表示這個結構。
    - **搜尋過程**：從根節點（查詢點）出發，沿著樹枝（分區）向下尋找最可能包含相似向量的路徑，同時**修剪掉（忽略）** 那些距離查詢點很遠、明顯不相關的分區（例如，圖中的黃色方塊被修剪，只搜尋紅色方塊區域）。
    - **結果**：最終只需要在最相關的「樹葉」（最小的子分區）中進行精確搜尋。
2. **資料量化 (Data Quantization)**：
    - **作法**：**壓縮**向量的表示方式，以節省儲存空間並加快索引建立和搜尋速度。
    - **舉例**：將一個 9 維的浮點數向量壓縮成 12 位元（bits）的表示。
3. **整合商業邏輯 (篩選 / Filtering)**：
    - **作法**：在進行向量相似度比對**之前**，先根據資料的元數據 (Metadata) 或業務規則進行**篩選**，限制搜尋範圍。
    - **舉例**：先篩選出「位於美國的度假村」或「紅色的洋裝」，然後**只在這些符合條件的項目中**進行向量搜尋，找出最相似的結果。

**Vertex AI Vector Search**

- Google Cloud 提供的**全代管**向量搜尋服務。
- 基於 ScaNN 或類似的先進技術建構（前身為 Matching Engine）。
- **優勢**：成本效益高（比同類服務便宜 30-50%）、搜尋速度快、低延遲、可擴展至數十億級別的向量。

**總結：**

建立高效的向量搜尋需要解決距離度量和快速搜尋兩大挑戰。雖然暴力搜尋精確但太慢，ANN（特別是 Google 的 ScaNN）透過空間修剪、資料量化和篩選等技術，實現了在犧牲微小精度的前提下，大幅提升大規模向量搜尋的速度和效率。Vertex AI Vector Search 將此技術包裝成易於使用的雲端服務。