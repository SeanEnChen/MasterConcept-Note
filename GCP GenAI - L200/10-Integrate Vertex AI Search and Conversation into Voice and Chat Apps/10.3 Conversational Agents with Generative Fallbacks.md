# 10.3 Conversational Agents with Generative Fallbacks

好的，這份實驗 (Lab) 的主要內容是關於如何使用 **Dialogflow CX**（在文中稱為 Conversational Agents console）中的 **生成式回退 (Generative Fallback)** 功能，來增強一個現有的對話機器人（名為 Divebooker，用於潛水預訂），使其能夠更智慧、更自然地處理超出預先設計流程的用戶輸入和問題。

以下是各個步驟的整理摘要、調整內容、原因以及調整前後的差異比較：

**Task 1 & 2: 設定與恢復代理 (Getting set up & Create/Restore Agent)**

- **步驟內容**：
    1. 從 GitHub 下載一個預先建立好的「Divebooker」對話機器人專案檔案 (`divebooker-agent.zip`) 到本地。
    2. 在 Dialogflow CX 控制台中，建立一個新的、空白的對話機器人（Agent），並設定基本資訊（名稱: Divebooker, 地點: us-central1, 語言: en 等）。
    3. 將下載的 `divebooker-agent.zip` 檔案透過「恢復 (Restore)」功能匯入到這個新建立的空白代理中。
- **調整了什麼**：從無到有建立了一個 Dialogflow CX 代理，並載入了預設的 Divebooker 結構。
- **為何調整**：為了提供一個基礎的、包含流程 (Flows)、意圖 (Intents)、實體 (Entities) 的對話機器人，以便後續專注於增強其「生成式回退」能力，而不是從零開始設計。
- **調整前後差異**：從一個空的代理變成了一個具有基本潛水預訂對話流程（雖然有限制）的代理。

**Task 3: 測試代理（基準線 - 未啟用生成式回退前）**

- **步驟內容**：使用 Dialogflow CX 內建的「模擬器 (Simulator)」與恢復好的 Divebooker 代理進行互動，觀察其在不同情況下的反應。
    - **情境 1 (未知問題)**：問代理一個它沒有被明確教導過的問題，例如「什麼是 liveaboard (船宿潛水)？」
        - **調整前後差異 (此為「前」)**：代理因為找不到匹配的「意圖 (Intent)」，會觸發預設的 `sys.no-match-default` 事件，並回應一些**預先寫好的、通用的、無法真正回答問題的句子**（例如 "What was that?", "Sorry, I didn't get that."）。
    - **情境 2 (正常流程/快樂路徑)**：模擬使用者預訂行程，提供必要資訊（例如「我想預訂明年七月去加拉巴哥群島，12 個人」）。
        - **調整前後差異 (此為「前」)**：代理能正確識別 `head.send.group.request` 這個意圖，並從句子中提取「目的地 (destination)」和「人數 (number-of-guests)」等參數，然後進入「收集更多資訊 (Collect Further Info)」頁面，**只詢問尚未提供**的資訊（例如聯絡方式），表現符合預期設計。
    - **情境 3 (無效輸入)**：在被要求提供目的地時，故意輸入一個無效的地點（例如「歐洲 Europe」，而代理只接受哥斯大黎加、加拉巴哥、墨西哥）。
        - **調整前後差異 (此為「前」)**：代理因為輸入值不符合 `destination` 這個「實體 (Entity)」的定義，會觸發該**參數層級**的 `No-match default` 事件，並回應一些**預先寫好的、提示使用者重新輸入有效目的地的句子**。
- **為何測試**：建立一個「基準線」，了解在沒有生成式 AI 輔助的情況下，傳統流程型機器人如何處理它懂和不懂的情況，突顯其侷限性（無法回答範圍外問題、錯誤處理較生硬）。

**Task 4: 啟用生成式回退 (Enable generative fallback)**

- **步驟內容**：進入代理的設定，針對特定的「未匹配 (no-match)」事件處理程序，勾選「啟用生成式回退 (Enable generative fallback)」選項。
    - 為**整個流程**的預設未匹配事件 (`Liveaboards` flow -> Start Page -> `sys.no-match-default`) 啟用。
    - 為**特定參數**的未匹配事件（`Collect Further Info` page -> Parameters -> `number-of-guests`, `destination`, `email-address` 各自的 `No-match default`）啟用。
- **調整了什麼**：開啟了讓 LLM 在特定情況下接管回應的功能。
- **為何調整**：目的是當代理遇到它自己處理不了的輸入時（找不到意圖或輸入值無效），**不再只是說預設的罐頭回應**，而是嘗試呼叫 LLM 來生成一個更自然、可能更有幫助的回應。
- **調整前後差異**：原本遇到 no-match 會說固定台詞，現在則會嘗試觸發 LLM 生成回應（但此時還沒配置好提示詞，效果可能不明）。

**Task 5 & 6: 配置生成式回退 - 選擇與定義提示 (Configure & Define Prompt)**

- **步驟內容**：
    1. 進入代理設定 (Settings) -> 生成式 AI (Generative AI) 分頁。
    2. 查看內建的提示模板（Default, Example），了解其基本能力（如打招呼、重複、等待、總結）。
    3. **定義並儲存一個自訂提示 (Custom Prompt)**。這個提示詞是給 LLM 的指令，包含：
        - 代理的**人設**（友善的潛水旅行助理）。
        - 代理**目前的能力範圍**（透過 `$flow-description` 佔位符動態載入流程描述）。
        - 代理**明確的限制**（不能協助陸地潛水、課程、推薦當地店家等）。
        - 代理**當前流程能做的事**（透過 `$route-descriptions` 佔位符動態載入當前活躍意圖的描述）。
        - **之前的對話紀錄**（透過 `${conversation}` 佔位符）。
        - **使用者最後一句話**（透過 `$last-user-utterance` 佔位符）。
    4. 將這個自訂提示設定為當前啟用的提示。
- **調整了什麼**：從使用預設/通用提示，改為使用一個為 Divebooker 量身打造的、包含詳細指令和動態上下文的自訂提示。
- **為何調整**：為了讓 LLM 生成的回應更符合 Divebooker 的**角色、能力限制和當前對話情境**。好的提示詞能引導 LLM 產生更準確、更有幫助、更符合期望的回應。佔位符使得提示能動態適應對話狀態。
- **調整前後差異**：生成式回退從使用通用指令變成使用包含豐富上下文和明確限制的客製化指令。

**Task 7: 添加流程和意圖描述 (Add flow and intent descriptions)**

- **步驟內容**：
    1. 為 `Liveaboards` 流程添加描述（例如："search, find and book liveaboards"）。
    2. 為 `head.send.group.request` 意圖添加詳細描述（包含：協助團體預訂、收集哪些資訊、目的地限制、人數限制 4-15 人等）。
- **調整了什麼**：補充了流程和意圖的文字描述。
- **為何調整**：因為 Task 6 定義的自訂提示中使用了 `$flow-description` 和 `$route-descriptions` 佔位符。這些描述現在會被**實際填入**提示中，傳遞給 LLM。這讓 LLM 在生成回退回應時，能**確切知道**當前流程是關於什麼的、這個意圖具體能處理哪些細節和限制（例如人數、地點限制）。
- **調整前後差異**：自訂提示中的佔位符從可能空缺或不清晰，變為能提供具體、有用的上下文資訊給 LLM。

**Task 8: 重新測試代理（啟用並配置生成式回退後）**

- **步驟內容**：再次使用模擬器，重複 Task 3 的測試情境，觀察**啟用並配置好**生成式回退後的**行為變化**。
    - **情境 1 (未知問題)**：再問「什麼是 liveaboard?」
        - **調整前後差異**：之前是通用錯誤回應，**現在代理會利用 LLM 生成一個關於 liveaboard 的解釋性回答**，因為自訂提示允許它在能力範圍內（雖然未明確定義此意圖，但可能根據流程描述和常識）嘗試回答。
    - **情境 2 (範圍外問題)**：問代理能否協助潛水課程。
        - **調整前後差異**：之前可能觸發 no-match，**現在代理會根據自訂提示中明確設定的限制（"can't help customers with... courses"），生成一個說明其無法提供此服務的回應**。
    - **情境 3 (正常流程 - 增強)**：重複預訂流程。
        - **調整前後差異**：基本流程不變，但如果使用者中途提出一些偏離腳本但相關的要求（例如「總結一下我的預訂資訊」、「我晚點給你電話號碼」），生成式回退**可能**會介入，提供更自然的對話互動，而不是直接忽略或報錯。
    - **情境 4 (無效輸入 - 人數)**：預訂時輸入超過 15 人（例如 20 人）。
        - **調整前後差異**：之前是通用的重新提示，**現在代理會生成一個更具體的回應，說明人數限制是 4-15 人**（這是 LLM 從 Task 7 添加的意圖描述中學習到的），並可能引導使用者修改人數。
    - **情境 5 (無效輸入 - 地點)**：預訂時輸入無效地點（例如「馬爾地夫 Maldives」）。
        - **調整前後差異**：之前是通用的重新提示，**現在代理會生成回應，說明可用的目的地選項**（哥斯大黎加、墨西哥、加拉巴哥，從意圖描述學習），而不是簡單地要求重試。（文中還展示了 LLM 收到的實際輸入，顯示佔位符已被替換）。
    - **情境 6 (禁用短語)**：在生成式 AI 設定中加入禁用短語（如 "Dangerous country"）。測試時輸入這些短語。
        - **調整前後差異**：啟用生成式回退後，如果輸入或 LLM 生成的回應觸發了禁用短語，**生成式回應會被阻止**，系統會**退回使用原本預先定義的、靜態的 Agent says 回應**，作為一種安全機制。
- **為何重新測試**：驗證啟用並配置好生成式回退後，代理在處理未知問題、超出範圍請求、無效輸入等情況時，是否表現得更智慧、更自然、更能提供有用資訊，以及安全機制是否生效。

**總結：**

這個 Lab 的核心是展示 Dialogflow CX 的**生成式回退**功能。透過**啟用**該功能，並精心**設計自訂提示**、**補充流程和意圖的描述**，可以讓原本流程固定、應對能力有限的對話機器人，在遇到意外情況（未知問題、無效輸入、範圍外請求）時，利用 LLM 的能力生成更像真人、更符合上下文、更能解決問題（或至少能解釋限制）的回應，同時還能透過禁用短語進行安全控制。這大大提升了使用者體驗和代理的健壯性，減少了為每種邊緣情況編寫固定腳本的工作量。