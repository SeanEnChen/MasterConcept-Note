# 8.5.2 Solution 1：Query expansion

**核心主題：介紹透過「Query expansion」技術來改善 RAG 系統檢索結果相關性的兩種主要方法。**

查詢擴展的目標是在執行向量搜尋**之前**，利用 LLM 來增強或修改原始的使用者查詢，以期能檢索到更相關、更能回答問題的文件，減少干擾項。

**方法一：使用「生成的答案」進行擴展 (Expansion using Generated Answers / Hypothetical Answer)**

1. **核心概念**：先讓 LLM 針對原始查詢「猜」一個可能的答案（即使這個答案可能是幻覺），然後將「原始查詢」和這個「假設性答案」合併，用這個組合後的內容去進行向量搜尋。
2. **運作流程**：
    - 使用者提出原始查詢（例如：「Alphabet 今年的財務表現如何？」）。
    - 將此查詢**單獨**先傳給 LLM，並提示它生成一個**假設性的答案**（例如：提示 LLM 扮演財務專家，給出一個可能在財報中找到的答案範例。LLM 可能回答：「財務結果令人滿意，因為增長了 24%。」）。
    - 將「**原始查詢**」和這個「**生成的假設答案**」**串接**起來。
    - 為這段**組合後的文本**生成一個嵌入向量。
    - 使用這個**新的組合嵌入向量**去執行向量搜尋，檢索最接近的文件。
    - 最後，將「**原始查詢**」和「**檢索到的文件**」一起送入 RAG 的最終步驟，讓 LLM 根據檢索到的真實文件生成最終、有根據的答案。
3. **目的/效果**：假設性答案提供了額外的上下文和關鍵詞，有助於將搜尋的焦點「拉向」向量空間中可能包含實際答案的區域，希望能避開一些僅僅是主題相關的干擾項。（視覺化圖顯示：生成的答案（灰圈）會影響原始查詢（紅圈）在空間中的有效位置，使檢索到的結果（藍塊）更接近這個「增強後」的查詢點）。

**方法二：使用「多個查詢」進行擴展 (Expansion using Multiple Queries / Query Generation)**

1. **核心概念**：讓 LLM 根據原始查詢，生成數個相關但角度不同的**額外查詢**。然後用**原始查詢加上所有生成的查詢**一起去執行向量搜尋，匯總所有檢索結果。
2. **運作流程**：
    - 使用者提出原始查詢（例如：「財務結果是什麼？」）。
    - 將此查詢傳給 LLM，並提示它生成多個（例如 5 個）相關的**子問題或不同角度的查詢**。（例如：提示 LLM 生成簡短、主題相關但涵蓋不同面向的問題，且格式需符合要求）。LLM 可能生成：「今年的收入有成長嗎？」、「該公司的股價是多少？」、「與去年相比，該公司的獲利能力如何？」。
    - 分別為「**原始查詢**」以及**所有「生成的查詢」** 都生成嵌入向量。
    - 對**每一個**查詢嵌入向量都執行一次向量搜尋，找出各自最接近的文件。
    - 將所有查詢檢索到的文件結果**匯總**起來，並進行**去重 (De-duplicate)**。
    - 最後，將「**原始查詢**」和這個**匯總去重後的、更廣泛的文件集合**一起送入 RAG 的最終步驟，讓 LLM 生成答案。
3. **目的/效果**：
    - **擴大搜尋範圍**：對於複雜問題，答案可能分散在不同主題的文件中，透過多個相關查詢可以更全面地捕捉所需資訊。
    - **提供更多資源**：為 LLM 提供更豐富的上下文資訊來生成最終答案。（視覺化圖顯示：多個查詢點（灰圈）分散在原始查詢（紅圈）周圍，使得檢索到的結果（藍塊）範圍更廣）。
4. **潛在問題**：由於檢索範圍擴大，**不可避免地**會引入更多可能相關性較低、甚至是干擾項的文件，需要後續 LLM 能有效篩選和利用資訊。

**總結：**

查詢擴展是在 RAG 流程的**檢索階段之前**，利用 LLM 對原始查詢進行預處理的技巧。可以使用「生成假設性答案」的方式來增加上下文、引導搜尋方向；也可以使用「生成多個相關查詢」的方式來擴大搜尋範圍、收集更全面的資訊。這兩種方法都旨在提高最終送入 LLM 的上下文文件的相關性，以生成更高品質的回應。
