# 8.5.1 Common pitfalls with RAG solutions

**核心主題：探討標準 RAG 工作流程中存在的「相關性」問題，以及介紹幾種提升檢索結果品質的方法。**

**標準 RAG 工作流程回顧：**

1. 使用者提出查詢 (Query)。
2. 將查詢轉換為嵌入向量。
3. 使用向量搜尋，在文件嵌入資料庫中找出與查詢向量最相似（距離最近）的文件嵌入。
4. 檢索這些最相似的文件。
5. 將原始查詢和檢索到的文件內容一起組合（增強提示），送給大型語言模型 (LLM)。
6. LLM 根據增強提示生成回應。

**RAG 面臨的關鍵挑戰：相似性 ≠ 相關性 (Similarity vs. Relevance)**

- **問題核心**：向量搜尋擅長找到**語意上相似**的文件（嵌入向量距離近），但這些文件**不一定真正回答了使用者的問題**，或與其查詢意圖**高度相關**。它們可能只是討論了相似的**主題**。
- **干擾項 (Distractors)**：檢索到的文件中，那些僅僅是主題相關但無法回答問題、甚至可能誤導 LLM 的內容，被稱為「干擾項」。
- **後果**：LLM 收到了包含干擾項的上下文，可能導致生成的回應**離題、不準確或毫無意義**。
- **診斷困難**：由干擾項導致的 RAG 系統錯誤，對於開發者和使用者來說都很難診斷和調試。
- **根本原因**：在檢索階段，嵌入模型和向量搜尋主要依賴預先計算好的語意相似度，它們並不知道使用者查詢背後**具體的回答需求或任務目標**。

**舉例說明問題：**

1. **不相關查詢**：
    - **情境**：一個 RAG 系統的知識庫是 Alphabet 公司的財務報告。
    - **使用者提問**：「湯姆·布雷迪（一位美式足球員）表現如何？」
    - **結果**：向量搜尋仍然會在財報資料中找出與查詢「語意最接近」（可能只是某些詞彙偶然相似）的文件。LLM 收到這些完全無關的財報內容，最終生成了基於財報資訊的、關於湯姆·布雷迪的**荒謬答案**。（視覺化圖：查詢點（紅圈）周圍的檢索結果（綠塊）都與查詢無關）。
2. **相關查詢但仍有干擾項**：
    - **使用者提問**：「Alphabet 對生成式 AI 的方法是什麼？」
    - **結果**：向量搜尋找到了許多提到「生成式 AI」的文件。其中一些可能直接相關（例如討論 GenAI 對財報的影響）。但很多可能只是**主題相關但非回答核心問題**（例如討論 GenAI 的治理、定價、成本、負責任 AI、一般技術投資等）。這些文件對 LLM 來說就是**干擾項**，導致最終的回應可能無法聚焦於 Alphabet 的「方法」。

**提升 RAG 檢索相關性的四種主要方法：**

為了解決上述問題，讓 RAG 系統回傳真正相關的內容並消除干擾，可以採用以下幾種技術（本課程將詳細探討）：

1. **查詢擴展 (Query Expansion)**：
    - **作法**：在進行向量搜尋**之前**，先使用 LLM 來**修改或擴展**原始的使用者查詢。
    - **方式**：例如，讓 LLM 為原始查詢生成一個可能的答案以補充上下文、用不同方式重寫查詢、或將原始查詢分解成多個相關的子查詢。
    - **目標**：使搜尋的目標更明確，提高找到真正能回答問題的文件的機率。
2. **交叉編碼器重排序 (Cross-Encoder Re-ranking)**：
    - **作法**：在**初步**的向量搜尋（召回階段）完成後，使用一種稱為「交叉編碼器 (Cross-Encoder)」的模型，對召回的文件列表進行**重新排序**。
    - **機制**：交叉編碼器會**同時**評估「查詢」和「單個召回文件」，並輸出一個更精確的相關性分數（不同於向量搜尋只比較向量距離）。
    - **目標**：將真正能回答查詢的文件排到更高的位置，降低干擾項的影響。
3. **嵌入適配器 (Embedding Adapters)**：
    - **作法**：訓練一個小型的「適配器」模型（類似於 PEFT 中的 Adapter），用來在向量搜尋**之前調整（微調）查詢嵌入向量**。
    - **機制**：可以根據使用者回饋或其他特定數據來訓練這個適配器，使其能將查詢向量「推向」包含更相關結果的向量空間區域，而無需重新訓練整個大型嵌入模型。
    - **目標**：使查詢嵌入更適應特定的檢索任務或領域。
4. **嵌入模型微調 (Fine-tuning the Embedding Model)**：
    - **作法**：直接**微調（或重新訓練）** 用於生成嵌入的**基礎模型本身**。
    - **機制**：使用特定領域或任務的標註數據（例如哪些文件對哪些查詢是相關的），來優化嵌入模型，使其能更好地將相關項目映射到向量空間中的鄰近位置。
    - **目標**：從根本上提升嵌入模型在特定應用場景下的表示能力和相關性判斷能力。

**總結：**

標準的 RAG 流程雖然有效，但僅依賴向量相似度可能檢索到不相關的「干擾項」，影響最終 LLM 回應的品質。為了建立更強大的 RAG 系統，需要採用如查詢擴展、交叉編碼器重排序、嵌入適配器或嵌入模型微調等技術，來提升檢索結果的「相關性」，而不僅僅是「相似性」。