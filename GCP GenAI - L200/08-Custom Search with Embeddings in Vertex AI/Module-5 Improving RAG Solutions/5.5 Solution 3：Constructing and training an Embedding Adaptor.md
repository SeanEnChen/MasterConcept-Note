# 8.5.5 Solution 3：Constructing and training an Embedding Adaptor

**核心主題：介紹利用「嵌入適配器」技術，根據回饋資料來調整查詢嵌入向量，以提升 RAG 檢索結果的相關性。**

**核心概念：嵌入適配器 (Embedding Adapters)**

- **目的**：改善 RAG 查詢結果相關性的另一種方法。它不是修改檢索到的文件排序，也不是修改基礎嵌入模型，而是**調整（或稱「適配」）查詢本身的嵌入向量**。
- **運作原理**：利用使用者回饋等標註資料，訓練一個小型的「適配器」模型（通常是一個矩陣）。在進行向量搜尋**之前**，將原始的查詢嵌入向量透過這個學習到的適配器進行轉換，得到一個「適配後」的查詢向量，再用這個新向量去搜尋。
- **目標**：透過學習，讓適配後的查詢向量在向量空間中的位置，能夠**更靠近**那些被標註為「相關」的文件向量，同時**遠離**那些被標註為「不相關」的文件向量。

**解決的問題：**

- 標準的查詢嵌入向量進行搜尋時，可能會同時召回相關和不相關的文件（如視覺化圖中，紅圈代表查詢，藍塊代表召回結果，有好有壞）。
- 我們希望利用已知的「好壞」結果資訊，來「校準」查詢向量，讓它下次搜尋時更能命中好結果。

**實作步驟：**

1. **準備標註資料集 (Labeled Dataset)**：
    
    - **收集查詢**：產生或收集代表性的使用者查詢（例如：可能會問財報的各類問題）。若有真實使用者查詢更佳。
    - **初步檢索**：使用這些查詢進行標準的向量搜尋，得到一批候選文件。
    - **人工標註**：**關鍵步驟！** 對於每個查詢，人工（或利用其他方法）判斷檢索到的每個文件是**相關的 (標記為 +1)** 還是**不相關的 (標記為 -1)**。你需要一個包含 `(查詢, 文件, 相關性標籤)` 的資料集。
2. **訓練嵌入適配器 (Train the Embedding Adapter)**：
    
    - **設定環境**：使用深度學習框架（如 PyTorch, Keras）。
    - **目標**：學習一個「適配器矩陣 (Adapter Matrix)」。
    - **訓練過程（概念）**：
        - **迭代優化**：重複執行一定次數的更新步驟（例如 100 次）。
        - **計算適配後查詢**：在每次迭代中，`適配後查詢向量 = 原始查詢向量 * 當前適配器矩陣`。
        - **評估相似度**：計算「適配後查詢向量」與資料集中標註文件的嵌入向量之間的餘弦相似度。
        - **計算損失 (Loss)**：使用損失函數（例如均方誤差 MSE），比較上一步計算出的相似度與目標標籤（+1 或 -1，可能需要映射到相似度範圍如 1 和 0）之間的差距。
        - **更新矩陣**：根據損失值，透過梯度下降等方法更新「適配器矩陣」的數值，目標是最小化損失。
        - **儲存最佳模型**：記錄訓練過程中損失最小的那個「適配器矩陣」，作為最終使用的 `best_matrix`。
3. **應用適配器進行查詢 (Apply Adapter During Querying)**：
    
    - **獲取原始查詢嵌入**：當有新的使用者查詢進來時，先用基礎嵌入模型產生其原始嵌入向量 (`query_embedding`)。
    - **轉換查詢嵌入**：計算 `adapted_query_embedding = query_embedding * best_matrix` （使用訓練好的最佳適配器矩陣）。
    - **執行向量搜尋**：使用這個**新的 `adapted_query_embedding`** 作為查詢向量，去你的向量資料庫（如 Vector Search 或 pgvector）中執行最近鄰搜尋。

**優點：**

- 透過學習使用者回饋或標註資料，可以針對特定任務或領域**微調查詢的表示方式**，提高檢索的相關性。
- **無需重新訓練**龐大且昂貴的基礎嵌入模型，只需訓練一個相對較小的適配器矩陣。

**總結：**

嵌入適配器提供了一種在不改變基礎嵌入模型的前提下，利用標註的回饋資料來優化 RAG 檢索相關性的方法。它透過訓練一個小型轉換矩陣來調整查詢向量，使其在向量空間中能更有效地找到被標註為相關的文件，進而提升 RAG 系統的表現。