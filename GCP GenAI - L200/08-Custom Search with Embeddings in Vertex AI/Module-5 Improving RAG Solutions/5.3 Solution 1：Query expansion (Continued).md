# 8.5.3 Solution 1：Query expansion (Continued)

**核心主題：介紹除了基本的查詢擴展外，更多用於處理 RAG 中複雜查詢、上下文不足及檢索結果不相關等問題的技巧。**

**技巧一：分解複雜查詢 (Decomposing Complex Queries)**

- **問題**：直接向 RAG 系統提出一個包含多個邏輯步驟或實體的複雜查詢，可能會因為系統難以一次性找到所有相關片段而導致答案不準確。
- **作法**：不直接問複雜問題，而是利用類似「思路鏈 (Chain-of-Thought)」的提示方法，將複雜問題**分解成一系列更簡單的子問題**，按順序進行檢索，並利用上一步的答案來形成下一步的查詢。這是一種「分治 (Divide and Conquer)」的策略。
- **舉例**：
    - **原始複雜查詢**：「喬治·華盛頓的妻子和湯瑪斯·傑佛遜的妹妹的大學室友是誰？」
    - **分解後的步驟**：
        1. **子查詢 1**：「喬治·華盛頓的妻子是誰？」 -> RAG 檢索得到答案：瑪莎·華盛頓 (Martha Washington) [稱作 X]。
        2. **子查詢 2**：「湯瑪斯·傑佛遜的妹妹是誰？」 -> RAG 檢索得到答案：簡·傑佛遜 (Jane Jefferson) [稱作 Y]。
        3. **子查詢 3**：「X (瑪莎·華盛頓) 和 Y (簡·傑佛遜) 的大學室友是誰？」 -> RAG 針對這個具體關係進行最終檢索。
- **優點**：讓檢索系統每次能專注於一個較小的問題，逐步累積資訊，有助於更精確地回答原始的複雜查詢。

**技巧二：檢索視窗 (Retrieval Window) - 擴展上下文**

- **問題**：標準 RAG 只檢索與查詢最相似的文件「區塊 (Chunks)」。但有時答案的完整上下文可能分散在該區塊的周圍（例如，一句話被切分到兩個區塊），導致 LLM 獲得的資訊不足以形成完整的回應。
- **作法**：在透過向量搜尋找到最相關的幾個區塊後，**不僅僅**將這幾個區塊的內容傳給 LLM，而是**擴大範圍**，將這些核心區塊**在原始文件中的「周圍」內容**（例如，它們前面和後面的區塊，或者它們所屬的整個章節）也一併提取出來，作為更豐富的上下文提供給 LLM。
- **舉例**：假設一份 Markdown 文件按層級分塊，向量搜尋找到了 `層級 3b 的區塊 2` 和 `層級 2b 的某個區塊` 是最相關的。使用檢索視窗技術，除了這兩個區塊的內容外，可能還會把 `層級 3b 的區塊 1`（前一個區塊）、甚至整個 `層級 2b` 的內容都提取出來，一起送給 LLM。
- **優點**：為 LLM 提供更完整的原始文件上下文，使其能夠生成更連貫、更準確、更有根據的答案。

**技巧三：查詢驗證 / 相關性檢查 (Query Validation / Relevance Check)**

- **問題**：即使使用者提出的查詢本身是相關的，標準 RAG 檢索到的「語意相似」的文件，仍可能包含與查詢**意圖不符**的內容（干擾項），導致 LLM 基於這些不相關的資訊亂回答（例如先前「湯姆·布雷迪」的例子）。
- **作法**：在將檢索到的文件和原始查詢傳送給 LLM 生成最終答案**之前**，加入一個**驗證步驟**，或者更直接地，在給 LLM 的**最終提示中加入明確指示**，要求它判斷檢索到的內容是否真的能回答問題。
- **舉例 (修改提示)**：在給 LLM 的最終指示中加入類似：「**請僅使用提供的財務報告文件來回答以下問題。如果答案在提供的文件中找不到，請回答『在提供的文件中找不到答案』。不要自行編造答案。**」
- **優點**：可以有效阻止 LLM 在檢索結果不相關或不足時產生幻覺或瞎猜，強制它在缺乏依據時承認無法回答，提高了回應的可靠性。

**總結：**

為了讓 RAG 系統更強大、更可靠，除了基本的檢索外，還可以運用其他技巧：對於複雜問題，可以將其分解成子問題逐步檢索；為了提供更完整的上下文，可以在檢索到核心區塊後擴大提取範圍（檢索視窗）；為了避免 LLM 基於不相關內容胡亂回答，可以在最終提示中加入驗證指令，要求其只在找到相關資訊時才作答。這些方法有助於提升 RAG 系統處理複雜情況和應對干擾資訊的能力。
