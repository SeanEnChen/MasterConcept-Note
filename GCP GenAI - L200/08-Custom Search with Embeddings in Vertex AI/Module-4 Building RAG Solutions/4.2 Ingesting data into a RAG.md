# 8.4.2 Ingesting data into a RAG

**核心主題：在將資料（特別是文件）提取到 RAG 系統之前，需要仔細考慮的資料處理步驟，尤其是分塊策略和利用 Document AI 進行複雜解析。**

**一、 大型文件的分塊 (Chunking) 策略：**

- **為何需要分塊？** Google Cloud 的 Embeddings API 對於單次能處理的文件數量和單一文件的大小（Token 數量）有限制。因此，大型文件必須先分割成較小的「塊 (Chunks)」。
- **分塊方法範例**：
    1. **固定大小分塊 (Fixed Size)**：例如，每 500 個 Token 切成一塊。簡單但可能切斷語意完整的段落。
    2. **上下文感知分塊 (Context-Aware)**：根據文件的自然邊界，如章節、段落來切分，更能保留語意完整性。
    3. **階層式分塊 (Hierarchical)**：基於文件的結構，如 Markdown 標題、LaTeX 結構，或針對表格等特定物件進行切分。
- **其他考量因素**：
    - **重疊 (Overlap)**：相鄰的區塊之間是否需要有少量內容重疊，以確保上下文的連續性？
    - **檢索大小 vs. 擷取大小**：有時答案可能分散在多個區塊中，即使是分開擷取的，檢索時可能需要將相關的多個區塊都找回來並組合。
    - **元數據 (Metadata)**：為每個區塊添加元數據（如標題、來源文件、頁碼等）非常重要，便於後續在向量搜尋時進行過濾。

**二、 使用 Document AI 進行複雜文件解析：**

- **挑戰**：在生成嵌入之前，解析文件（尤其是 PDF、圖片、包含表格的文件）可能非常複雜。
- **解決方案：Document AI**
    - Google Cloud 的一項服務，能自動解析多種格式的文件，提取文字、辨識圖像、理解表格結構等，將非結構化資料轉換為結構化資料。
    - 使用「註釋器 (Annotators)」來提取和豐富內容。
    - **舉例**：從愛因斯坦的傳記文本中，Document AI 可以提取出命名實體（國家：德國，研究領域：相對論），甚至生成整段文字的摘要描述。
    - **優點**：相比簡單的文字提取，Document AI 能理解文件版面、表格、圖像等關係，提供更高品質的結構化資料，這有助於生成更精確、更有用的嵌入向量，提升 RAG 效果。
- **整合生態系**：
    - Document AI 解析出的結構化資料，可以方便地儲存到 **BigQuery**（Google Cloud 的數據倉儲）中。
    - 可進一步使用 **Knowledge Graph Search API** 豐富提取出的實體資訊，或用 **Places API** 豐富地點資訊。
    - 儲存在 BigQuery 中的結構化資料，可以使用 **Looker Studio**（較簡單）或 **Looker**（進階 BI）進行視覺化分析。

**三、 Document AI 處理架構：同步 vs. 非同步**

選擇哪種架構主要取決於應用的**延遲 (Latency)** 需求。

1. **同步架構 (Synchronous Architecture)**：
    
    - **適用場景**：需要**即時**處理和回應的用例。例如，使用者上傳一份文件，需要立刻得到處理結果或確認訊息，使用者正在線上等待。
    - **運作流程 (簡化)**：
        1. 事件觸發 (如檔案上傳) -> 呼叫 **Cloud Functions**。
        2. Cloud Functions **同步呼叫** Document AI API（可能是分割器/分類器，然後是特定處理器）。這表示程式會**等待** API 完成才繼續執行。
        3. 一次處理**單一文件**，文件內容通常以 Base64 編碼的字串形式內嵌在請求中。
        4. (可選) 人工審核步驟。
        5. 結果直接回傳給 Cloud Functions。
        6. 後續可進行 ETL (如使用 **Dataflow**/Apache Beam) 並儲存 (如 **BigQuery**)。
        7. Cloud Functions 將最終結果/狀態回傳給原始觸發流程/使用者。
    - **優點**：即時回應。
    - **缺點**：阻塞式呼叫、一次只能處理一份文件、對單一文件的頁數/大小限制可能較嚴格、整體吞吐量較低。
2. **非同步架構 (Asynchronous Architecture)**：
    
    - **適用場景**：需要**批次處理大量文件**，對即時性要求不高，但重視**高吞吐率**的場景。
    - **運作流程 (簡化)**：
        1. 文件需先上傳/複製到 **Cloud Storage**。
        2. 批次文件準備好後 -> 發布訊息到 **Cloud Pub/Sub** 主題。
        3. Pub/Sub 觸發 **Cloud Functions**。
        4. Cloud Functions **非同步呼叫** Document AI API。這表示呼叫後**立即返回**一個 `OPERATION_ID`，不會阻塞等待。
        5. 一次可以處理**一批文件** (輸入是 Cloud Storage 上的文件 URI 列表)。
        6. 應用程式需要**輪詢 (Polling)** Document AI 的操作 (Operation) 資源，使用 `OPERATION_ID` 來檢查處理狀態。
        7. 處理完成後，結果會寫入指定的 **Cloud Storage** 儲存桶。
        8. 後續流程 (如 ETL/Dataflow) 從 Cloud Storage 讀取結果進行處理並儲存 (如 **BigQuery**)。
    - **優點**：高吞吐率（可同時處理大量文件）、非阻塞、對單一文件的頁數/大小限制通常比同步模式寬鬆得多。與同步 API **無價格差異**。
    - **缺點**：非即時回應、應用程式需要實作輪詢邏輯來獲取結果、需要考慮資料暫存於 Cloud Storage 的情況（有 TTL 且受加密保護）。

**總結：**

將資料有效地匯入 RAG 系統需要仔細規劃。大型文件需要透過合理的分塊策略（固定大小、上下文感知、階層式）來處理，並添加元數據。對於 PDF、圖片、表格等複雜格式，使用 Document AI 進行預先解析可以產生更高品質的結構化資料，進而生成更好的嵌入。根據應用對延遲和吞吐量的需求，可以選擇同步（即時、單文件）或非同步（批次、高吞吐）的 Document AI 處理架構。